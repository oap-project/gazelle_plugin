<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Columnar UDF Development - Gazelle Plugin - 1.5.0</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Columnar UDF Development";
        var mkdocs_page_input_path = "Columnar-UDF-Development-Guide.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Gazelle Plugin - 1.5.0
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../User-Guide/">User Guide</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Prerequisite/">Prerequisite</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Installation/">Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../InstallationNotes/">InstallationNotes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Configuration/">Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../SparkInstallation/">SparkInstallation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ApacheArrowInstallation/">ApacheArrowInstallation</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Columnar UDF Development</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#hive-udf">Hive UDF</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scala-udf">Scala UDF</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#reference-to-developer">Reference to Developer</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../memory/">Memory Allocation in Gazelle Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../performance/">Performance Tuning for Gazelle Plugin</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../OAP-Installation-Guide/">OAP Installation Guide</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../OAP-Developer-Guide/">OAP Developer Guide</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../../">Version Selector</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Gazelle Plugin - 1.5.0</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Columnar UDF Development</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="columnar-udf-development-guide">Columnar UDF Development Guide</h2>
<p>Developer can implement columnar Hive UDF or scala UDF in Gazelle for performance benefits.</p>
<p>The original UDF still needs to be registered to Spark for two reasons: 1) Spark will create a kind of
expression for the registered UDF, which makes expression replacement possible. 2) expression fallback
still need work well for cases that the expression tree has some expression currently unsupported by Gazelle.</p>
<h3 id="hive-udf">Hive UDF</h3>
<p>Suppose there is a UDF for handling string type input.</p>
<pre><code>package com.intel.test;

import org.apache.hadoop.hive.ql.exec.UDF;

public class MyHiveUDF extends UDF {

  public String evaluate(String b) {
    ...
  }
}
</code></pre>
<p>The jar contains this class should be put into Spark class path. Then, the UDF can be registered
to Spark at runtime as the below shows.</p>
<p><code>spark.sql("CREATE TEMPORARY FUNCTION MyHiveUDFName AS 'com.intel.test.MyHiveUDF';")</code></p>
<p><code>MyHiveUDFName</code> is the unique name for UDF and it's case insensitive to Spark &amp; Gazelle.</p>
<p>We need to implement a native version of <code>evaluate</code> function in <code>arrow/gandiva</code>. And in Gazelle
<code>ColumnarExpressionConverter.scala</code>, we need to add some logic to find the expression whose pretty
name is <code>MyHiveUDFName</code>, and replace it with the implemented columnar expression. The columnar
expression will call gandiva function for evaluating given input.</p>
<h3 id="scala-udf">Scala UDF</h3>
<p>In Gazelle, the implementation for scala UDF is similar to Hive UDF. There is only few difference
in finding the matched expression for replacing it. See code details in <code>ColumnarExpressionConverter.scala</code>.</p>
<p>We still need to register the original scala UDF to Spark, e.g.,</p>
<p><code>spark.udf.register("MyScalaUDFName", (s : String) =&gt; s)</code></p>
<p>It is also required to implement a columnar expression and a gandiva function, similar to Hive UDF.</p>
<h3 id="reference-to-developer">Reference to Developer</h3>
<p><a href="https://github.com/oap-project/gazelle_plugin/pull/925">Support a UDF: URLDecoder</a></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ApacheArrowInstallation/" class="btn btn-neutral float-left" title="ApacheArrowInstallation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../memory/" class="btn btn-neutral float-right" title="Memory Allocation in Gazelle Plugin">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ApacheArrowInstallation/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../memory/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
